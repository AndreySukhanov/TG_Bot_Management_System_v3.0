"""
–û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
–°–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–º–∞–Ω–¥—ã start, help –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
"""

from aiogram import Dispatcher, F
from aiogram.types import Message, ReplyKeyboardRemove
from aiogram.filters import Command
from utils.config import Config
from utils.logger import log_action
# from utils.keyboards import get_main_menu_keyboard
from utils.bot_commands import BotCommandManager
import logging

logger = logging.getLogger(__name__)


async def start_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = message.from_user.id
    username = message.from_user.username or "Unknown"
    
    log_action(user_id, "start", f"username: {username}")
    
    config = Config()
    user_role = config.get_user_role(user_id)
    
    if user_role == "unknown":
        await message.answer(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.\n"
            "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π."
        )
        return
    
    role_messages = {
        "marketer": (
            "üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ <b>–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥</b>.\n\n"
            "üìù <b>–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É:</b>\n"
            "üÜï <b>–¢–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫!</b>\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞:</b>\n"
            "‚Ä¢ <code>–ü—Ä–∏–≤–µ—Ç, –º–Ω–µ –Ω—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å —Ñ–µ–π—Å–±—É–∫ –Ω–∞ —Å–æ—Ç–∫—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ê–ª—å—Ñ–∞ —á–µ—Ä–µ–∑ –∫—Ä–∏–ø—Ç—É</code>\n"
            "‚Ä¢ <code>–ù—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ –≥—É–≥–ª –∞–¥—Å 50 –¥–æ–ª–ª–∞—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç –ë–µ—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω +1234567890</code>\n"
            "‚Ä¢ <code>–û–ø–ª–∞—Ç–∏ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º 200$ –ø—Ä–æ–µ–∫—Ç –ì–∞–º–º–∞ —Å—á–µ—Ç 1234-5678</code>\n\n"
            "<b>–ò–ª–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç:</b>\n"
            "‚Ä¢ <code>–ù—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ Facebook Ads –Ω–∞ —Å—É–º–º—É 100$ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ Alpha, –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞: 0x1234...abcd</code>\n\n"
            "‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏"
        ),
        "financier": (
            "üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ <b>–§–∏–Ω–∞–Ω—Å–∏—Å—Ç</b>.\n\n"
            "üíº <b>–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö –Ω–∞ –æ–ø–ª–∞—Ç—É\n"
            "‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π <code>–û–ø–ª–∞—á–µ–Ω–æ [ID]</code>\n"
            "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞: /balance\n\n"
            "‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏"
        ),
        "manager": (
            "üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ <b>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</b>.\n\n"
            "üë®‚Äçüíº <b>–í–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "‚Ä¢ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫):\n"
            "  - <code>Added 1000$</code> (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)\n"
            "  - <code>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 500</code>\n"
            "  - <code>–î–æ–±–∞–≤–∏—Ç—å 200 –Ω–∞ –±–∞–ª–∞–Ω—Å</code>\n"
            "‚Ä¢ –û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:\n"
            "  - <code>/resetbalance</code> (–∫–æ–º–∞–Ω–¥–∞)\n"
            "  - <code>–û–±–Ω—É–ª–∏ –±–∞–ª–∞–Ω—Å</code> (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫)\n"
            "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: /balance –∏–ª–∏ /stats\n"
            "‚Ä¢ AI-–ø–æ–º–æ—â–Ω–∏–∫: /ai –∏–ª–∏ –æ–±—ã—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n"
            "‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–∏–∑–∫–æ–º –±–∞–ª–∞–Ω—Å–µ\n\n"
            "‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å–ø—Ä–∞–≤–∫–∏"
        )
    }
    
    await message.answer(
        role_messages[user_role], 
        parse_mode="HTML",
        reply_markup=ReplyKeyboardRemove()
    )
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    try:
        command_manager = BotCommandManager(message.bot)
        await command_manager.set_commands_for_user(user_id, user_role)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–º–∞–Ω–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")


async def help_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    user_id = message.from_user.id
    config = Config()
    user_role = config.get_user_role(user_id)
    
    if user_role == "unknown":
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    help_messages = {
        "marketer": (
            "üìñ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞</b>\n\n"
            "üÜï <b>–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è):</b>\n"
            "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –æ–±—ã—á–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏!\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞:</b>\n"
            "‚Ä¢ <code>–ü—Ä–∏–≤–µ—Ç, –º–Ω–µ –Ω—É–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å —Ñ–µ–π—Å–±—É–∫ –Ω–∞ —Å–æ—Ç–∫—É –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ê–ª—å—Ñ–∞ —á–µ—Ä–µ–∑ –∫—Ä–∏–ø—Ç—É</code>\n"
            "‚Ä¢ <code>–ù—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ –≥—É–≥–ª –∞–¥—Å 50 –¥–æ–ª–ª–∞—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç –ë–µ—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω +1234567890</code>\n"
            "‚Ä¢ <code>–û–ø–ª–∞—Ç–∏ –∏–Ω—Å—Ç–∞–≥—Ä–∞–º 200$ –ø—Ä–æ–µ–∫—Ç –ì–∞–º–º–∞ —Å—á–µ—Ç 1234-5678</code>\n"
            "‚Ä¢ <code>–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ —Ç–∏–∫—Ç–æ–∫ 75$ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –î–µ–ª—å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–ª—è—é —Ñ–∞–π–ª</code>\n\n"
            "<b>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã:</b>\n"
            "1. <b>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞:</b>\n"
            "   <code>–ù—É–∂–Ω–∞ –æ–ø–ª–∞—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ [–ù–ê–ó–í–ê–ù–ò–ï] –Ω–∞ —Å—É–º–º—É [–°–£–ú–ú–ê]$ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ [–ü–†–û–ï–ö–¢], –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞: [–ê–î–†–ï–°_–ö–û–®–ï–õ–¨–ö–ê]</code>\n\n"
            "2. <b>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</b>\n"
            "   <code>–û–ø–ª–∞—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ [–ù–ê–ó–í–ê–ù–ò–ï] –Ω–∞ [–°–£–ú–ú–ê]$ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ [–ü–†–û–ï–ö–¢], –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: [–¢–ï–õ–ï–§–û–ù]</code>\n\n"
            "3. <b>–°—á–µ—Ç/QR-–∫–æ–¥:</b>\n"
            "   <code>–û–ø–ª–∞—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ [–ù–ê–ó–í–ê–ù–ò–ï] –Ω–∞ [–°–£–ú–ú–ê]$ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ [–ü–†–û–ï–ö–¢], —Å—á–µ—Ç:</code> + –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª\n\n"
            "<b>–°—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–æ–∫:</b>\n"
            "‚Ä¢ ‚è≥ <b>pending</b> - –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã\n"
            "‚Ä¢ ‚úÖ <b>paid</b> - –æ–ø–ª–∞—á–µ–Ω–æ\n"
            "‚Ä¢ ‚ùå <b>rejected</b> - –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
        ),
        "financier": (
            "üìñ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç–∞</b>\n\n"
            "<b>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã:</b>\n"
            "–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:\n"
            "<code>–û–ø–ª–∞—á–µ–Ω–æ [ID_–ó–ê–Ø–í–ö–ò]</code> + –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (—Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Å–∫—Ä–∏–Ω—à–æ—Ç, —á–µ–∫)\n\n"
            "<b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
            "‚Ä¢ <code>–û–ø–ª–∞—á–µ–Ω–æ 123</code> + —Å–∫—Ä–∏–Ω—à–æ—Ç\n"
            "‚Ä¢ <code>–û–ø–ª–∞—á–µ–Ω–æ 124, —Ö—ç—à: 0xabc123...</code>\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
            "‚Ä¢ /balance - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å"
        ),
        "manager": (
            "üìñ <b>–°–ø—Ä–∞–≤–∫–∞ –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è</b>\n\n"
            "üÜï <b>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞):</b>\n\n"
            "<b>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç:</b>\n"
            "‚Ä¢ <code>Added 1000$</code>\n"
            "‚Ä¢ <code>Added 500$ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ X</code>\n\n"
            "<b>–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫:</b>\n"
            "‚Ä¢ <code>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 1000</code>\n"
            "‚Ä¢ <code>–î–æ–±–∞–≤–∏—Ç—å 500 –Ω–∞ –±–∞–ª–∞–Ω—Å</code>\n"
            "‚Ä¢ <code>–ó–∞–∫–∏–Ω—å 200 –¥–æ–ª–ª–∞—Ä–æ–≤</code>\n"
            "‚Ä¢ <code>1000$ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –ê–ª—å—Ñ–∞</code>\n\n"
            "‚ö†Ô∏è <b>–û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞:</b>\n"
            "‚Ä¢ <code>/resetbalance</code> - –∫–æ–º–∞–Ω–¥–∞ –æ–±–Ω—É–ª–µ–Ω–∏—è\n"
            "‚Ä¢ <code>–û–±–Ω—É–ª–∏ –±–∞–ª–∞–Ω—Å</code> - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫\n"
            "‚Ä¢ <code>–û—á–∏—Å—Ç–∏ –±–∞–ª–∞–Ω—Å</code> - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫\n"
            "‚Ä¢ <code>–ë–∞–ª–∞–Ω—Å 0</code> - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫\n\n"
            "<b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>\n"
            "–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –±–∞–ª–∞–Ω—Å–µ –Ω–∏–∂–µ 100$\n\n"
            "<b>–ö–æ–º–∞–Ω–¥—ã:</b>\n"
            "‚Ä¢ /start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
            "‚Ä¢ /balance –∏–ª–∏ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –±–∞–ª–∞–Ω—Å\n"
            "‚Ä¢ /ai - AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n"
            "‚Ä¢ /resetbalance - –æ–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞"
        )
    }
    
    await message.answer(help_messages[user_role], parse_mode="HTML", reply_markup=ReplyKeyboardRemove())


async def unauthorized_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    user_id = message.from_user.id
    username = message.from_user.username or "Unknown"
    
    log_action(user_id, "unauthorized_access", f"username: {username}")
    
    await message.answer(
        "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.\n"
        "–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π."
    )


async def default_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    user_id = message.from_user.id
    username = message.from_user.username or "Unknown"
    
    logger.info(f"–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id} ({username}): {message.text}")
    
    config = Config()
    role = config.get_user_role(user_id)
    
    if role == "unknown":
        await unauthorized_handler(message)
        return
    
    # –î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    role_emojis = {
        "marketer": "üì±",
        "financier": "üí∞", 
        "manager": "üë®‚Äçüíº"
    }
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
    commands_text = ""
    if role == "manager":
        commands_text = (
            "‚Ä¢ /start - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - üìã –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å\n"
            "‚Ä¢ /balance - üí∞ –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å\n"
            "‚Ä¢ /stats - üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã\n"
            "‚Ä¢ /ai - ü§ñ AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n"
            "‚Ä¢ /dashboard - üìä –í–µ–±-–¥–∞—à–±–æ—Ä–¥ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏\n"
            "‚Ä¢ /resetbalance - ‚ö†Ô∏è –û–±–Ω—É–ª–∏—Ç—å –±–∞–ª–∞–Ω—Å"
        )
    elif role == "financier":
        commands_text = (
            "‚Ä¢ /start - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - üìã –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å\n"
            "‚Ä¢ /balance - üí∞ –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å"
        )
    elif role == "marketer":
        commands_text = (
            "‚Ä¢ /start - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - üìã –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å\n"
            "‚Ä¢ /examples - üìù –ü—Ä–∏–º–µ—Ä—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–æ–∫\n"
            "‚Ä¢ /formats - üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã\n"
            "‚Ä¢ /natural - üó£Ô∏è –ü—Ä–∏–º–µ—Ä—ã –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞"
        )
    else:
        commands_text = (
            "‚Ä¢ /start - üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help - üìã –°–ø—Ä–∞–≤–∫–∞ –∏ –ø–æ–º–æ—â—å"
        )
    
    await message.answer(
        f"{role_emojis.get(role, '‚ùì')} <b>–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞:</b> <code>{message.text}</code>\n\n"
        f"<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        f"{commands_text}\n\n"
        f"–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–µ–Ω—é.",
        parse_mode="HTML"
    )


def setup_common_handlers(dp: Dispatcher):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
    dp.message.register(start_handler, Command("start"))
    dp.message.register(help_handler, Command("help"))
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    def is_authorized(message: Message) -> bool:
        return Config.is_authorized(message.from_user.id)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–ü–û–°–õ–ï–î–ù–ò–ô!)
    # –ò—Å–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤—ã–µ, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏ –¥—Ä—É–≥–∏–µ –º–µ–¥–∏–∞
    dp.message.register(default_handler, F.content_type.in_({"text"}))
    
    logger.info("‚úì –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ common –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
